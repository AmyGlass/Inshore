---
title: Inshore Scallop Assessment Order of Operations
author: Brittany Wilson
date: 2021-05-18
output:
  html_document:
    toc: true
    theme: lumen
  pdf_document:
    toc: true
    includes:
      in_header: style.tex
always_allow_html: true
css: style.css
---

```{r Setup, include = FALSE}

require(usethis)
require(lubridate)
require(fs)
require(tidyverse)
require(flextable)
require(shinyWidgets)
#devtools::install_github("timelyportfolio/sweetalertR") #required for pop up reminders to save changes to github.
#require(sweetalertR)


#To use this Rmarkdown as a guide to run scripts, it requires you to have forked the Marscal Inshore repository (https://github.com/Mar-scal)

#Set working directory to *YOUR FORKED INSHORE REPOSITORY* (Not the Marscal master versions on ESS).
#dir <- ("https://github.com/Mar-scal/Inshore/tree/main/") #Github
dir <- ("C:/Users/WILSONB/Documents/GitHub/Inshore") #Brittany
#dir <- () #Jamie
#dir <- () #Jessica

#Remember to follow github workflow (i.e. commiting all changes with details (see commit protocol document (*To be made*)), pushing those changes up to your github forked repository and merging with the master Inshore repo on Marscal.
```


# Overview

This document is intended as a guide to the inshore scallop assessment workflow and the R-scripts that are used in the assessment process. This document can be used as a Rmarkdown allowing the user to open the required scripts within Rstudio, or be read as a html or PDF document where the user can review the workflow and manually locate the scripts witin the specified directory.

The inshore assessment is separated by area:

**Bay of Fundy**: SPA1A, SPA1B, SPA3, SPA4 and SPA5, and SPA6

**SFA29W**: A, B, C, D, E


# Bay of Fundy


## 1. Standard Depth

```{r Open Standardize_depth.R, include = FALSE}
usethis::edit_file(paste0(dir, "/StandardDepth/Standardize_depth.R")) #Opens Standardize_depth.R
```

  * **Script Directory:** 
  
      To be your forked Marscal Inshore repository path (e.g. `r paste0(dir, "/StandardDepth")` )

  * **Purpose:** 
  
      This script is used to pull bathymetry values from survey point locations and appends it to survey data (i.e. standardize depth values). 
    
  * **Output(s):** 
  
      towsdd_StdDepth.csv
    
  * **Output Directory(s):** 
  
      ESS:/INSHORE SCALLOP/StandardDepth
    
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to the script Standardize_depth.R have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------


## 2. Meat Weight - Shell Height and Condition modeling (Growth)

```{r open MeatweightShellHeight.R files, include = FALSE}
#year <- year(Sys.Date())-1 #Extract previous years folder structure for example
#dir_tree(path = paste0("Y:/INSHORE SCALLOP/BoF/", year, "/Assessment/Scripts/Growth")) #Prints out directory structure
rm(list = ls()) #Clear Global Environment

usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/BoF_MeatWeightShellHeight_2020.R") #Script for SPA 1A, 1B, 4 and 5.
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA3_MeatWeightShellHeight_2020.R") #Script for SPA 3
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA6_MeatWeightShellHeight_2020.r") #Script for SPA 6

#Eventually will be housed on github repo ???
#usethis::edit_file(paste0(dir, "/Growth/BoF_MeatWeightShellHeight.R"))
#usethis::edit_file(paste0(dir, "/Growth/SPA3_MeatWeightShellHeight.R"))
#usethis::edit_file(paste0(dir, "/Growth/SPA6_MeatWeightShellHeight.r"))
```


  * **Script Directory:** 
  
      Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth 
      (eventually to be our forked Marscal/inshore repository, e.g. `r paste0(dir, "/Growth")`)
    
  * **Purpose:** 
  
      The MeatWeightShellHeight.R scripts predicts meat weight with shell height and depth.
      
  * **Overview:** 
  
    1. Set up data for modelling:
      - Query detailed meat weight/shell height sampling data from database (scallsur.scwgthgt) for specified cruises (SPA1A1B4and5, SPA3, SPA6).
      - Query Shell height bin data from database (scallsur.scliveres) for specified cruises (SPA1A1B4and5, SPA3, SPA6).
      - Format and merge depth information (from towsdd_StdDepth.csv) to the meat weight/shell height dataframe (BFdetail).
      - Format and merge depth information (from towsdd_StdDepth.csv) to the shell height bin data (BFlivefreq).
      
      Run the Meat Weight Shell Height Model:
      - Subset for the survey year, shell height > 40mm
      - Centre Height and Depth values (e.g log height - mean(log height))
      - Run model (GLM) predicting meat weight (wet) with shell height (centred), depth (centred) and mixed effects of log height and tow number.
      - Assess/plot residuals (full area and by tow) and fitted data.
    
      Predicting:
      - Subset for the survey year
      - Centre Height values (log of the midpoint of the bins - mean of the log height)
      - Centre Depth values (log depth - mean(test.data$Log.DEPTH)
      - Create a matrix of depths by tow to use in predict function
      - Predict using Random effects for tows where meat weight shell height samples were taken - gives MWT-SH relationship for one individual
      - Predict using Fixed effects for tows where meat weight shell height samples were not taken - gives MWT-SH relationship for one individual
      - Multiply prediction matrix (weight) by live numbers to get weight/bin size
      
   2. Condition data for Spatial plots
      - centre depth using same mean depth used in the MWTSH model (mean(test.data$Log.DEPTH))
      - Subset for tows that were sampled for meat weight shell height
      - Predict a meat weight for 100mm for just sampled tows.
      
      
      
  * **Output(s):** 
  
    - **SPA 1A, 1B, 4 and 5**
      
      - BFliveweight.csv  (MWTSH)
    
      - BFConditionforMap.csv (Condition)
      
      - BFgrowthYYYY.RData
      
      - Figures: BFtowdepthYYYY.png, MWTSHBFYYYY.png, MWTSHBFYYYY_towresid.png, and MWTSHBFYYYY_towfit.png
      
    - **SPA 3**
    
      - BIliveweight.csv (MWTSH)
    
      - BIConditionforMap.csv (Condition)
      
      - BIgrowthYYYY.RData
      
      - Figures: BItowdepthYYYY.png, MWTSHBIYYYY.png, MWTSHBIYYYY_towresid.png, and MWTSHBIYYYY_towfit.png
    
    - **SPA 6**
    
      - GMliveweight.csv (MWTSH)
    
      - GMConditionforMap.csv (Condition)
      
      - GMgrowthYYYY.RData
      
      - Figures: GMtowdepthYYYY.png, MWTSHGMYYYY.png, MWTSHGMYYYY_towresid.png, and MWTSHGMYYYY_towfit.png
      
    - **Other**
    
      - AREA_ConditionTimeSeries.png (Condition Time series)


    
  * **Output Directory(s):** 
  
    - **SPA 1A, 1B, 4 and 5**
    
      - Y:/INSHORE SCALLOP/BoF/YYYY/Assessment/Data/SurveyIndices/SPA1A1B4and5 (.csv)
      
    - **SPA 3** 
    
      - Y:/INSHORE SCALLOP/BoF/YYYY/Assessment/Data/SurveyIndices/SPA3 (.csv)
      
    - **SPA 6** 
    
      - Y:/INSHORE SCALLOP/BoF/YYYY/Assessment/Data/SurveyIndices/SPA6 (.csv)
      
    - **Figures**
    
      - Y:/INSHORE SCALLOP/BoF/YYYY/Assessment/Figures/Growth (.png)
      
      - Y:/INSHORE SCALLOP/BoF/YYYY//Assessment/Figures (Condition time series .png)
      
     
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to scripts MeatWeightShellHeight.R for each SPA have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------


## 3. Spatial plots (Survey Indices)

```{r open Spatial plot scripts, include = FALSE}
#year <- year(Sys.Date())-1 #Extract previous years folder structure for example
usethis::edit_file(paste0(dir, "/SurveyIndices/BoFSpatialPlotsofSurveyData_pecjector.r"))
```


  * **Purpose:** Plot spatial patterns for Density, Biomass, Condition, Meat Count and Clapper data for the Full Bay of Fundy extent, SPA1A, 1B, 3, 4 and 5, and 6.
    
  * **Script Directory:** To be your forked Marscal Inshore repository path (e.g. C:/Users/WILSONB/Documents/GitHub/Inshore/SurveyIndicies)
  
  * **Output(s):**
  
    - **Spatial plots for each area and commercial, recruit and pre-recruit size ranges**
    
      - Density - ContPlot_SPA#_ComDensityYYYY.png, ContPlot_SPA#_RecDensityYYYY.png, ContPlot_SPA#_PreDensityYYYY.png
      
      - Biomass - ContPlot_SPA#_ComBiomassYYYY.png, ContPlot_SPA#_RecBiomassYYYY.png, ContPlot_SPA#_PreBiomassYYYY.png
      
      - Condition - ContPlot_SPA#_ConditionYYYY.png (using only commercial sizes)
      
      - Meat Count - ContPlot_SPA#_MeatcountYYYY.png (using only commercial sizes)
      
      - Clappers and Clapper proportion - ContPlot_SPA#_ComClappersYYYY.png, ContPlot_SPA#_RecClappersYYYY.png,
                                          ContPlot_SPA#_PropComClappersYYYY.png, ContPlot_SPA#_PropRecClappersYYYY.png
      
  
  * **Output Directory(s):** Y:/INSHORE SCALLOP/BoF/YYYY/Assessment/Figures

  
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to BoFSpatialPlotsofSurveyData_pecjector.r have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------


## 4. VonB (Growth)

```{r Open AREA_VonB_YYYY.R, include = FALSE}

usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/BoF_VonB_2016.R") #Script for SPA 1A, 1B, 4 and 5 (last updated 2016).
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA3_VonB_2017.R") #Script for SPA 3 (last updated 2017)
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA6_VonB_2017.R") #Script for SPA 6 (last updated 2017)
```
    
  * **Script Directory:** 
  
  * **Purpose:**
  
  * **Output(s):**
    
  * **Output Directory(s):** 
  
  
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to BoFSpatialPlotsofSurveyData_pecjector.r have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------

## 5. Shell Height Frequencies (Growth)

```{r Open AREA_SHF_YYYY.R, include = FALSE}

usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA1A_SHF_2020_new.R")
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA1B_SHF_2020_new.R")
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA3_SHF_2020.R")
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA4_SHF_2020.R")
usethis::edit_file("Y:/INSHORE SCALLOP/BoF/2020/Assessment/Scripts/Growth/SPA4_SHF_2020.R")
```
    
  * **Script Directory:** 
  
  * **Purpose:**
  
  * **Output(s):**
    
  * **Output Directory(s):** 
  
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to BoFSpatialPlotsofSurveyData_pecjector.r have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------


## 6. Growth Rates (Growth)
    
  * **Script Directory:** 
  
  * **Purpose:**
  
  * **Output(s):**
    
  * **Output Directory(s):** 
  
-------------------------------------------------------------------------

::: {.infobox .caution data-latex="{caution}"}
**COMMIT CHANGES**

Ensure that all changes made to BoFSpatialPlotsofSurveyData_pecjector.r have been saved and pushed to Marscal Inshore repository before continuing!
:::

-------------------------------------------------------------------------
